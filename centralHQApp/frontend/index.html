<html>
    <head>
        <link href="//netdna.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap.min.css" rel="stylesheet">
        <link href="./css/styles.css" rel="stylesheet">
    </head>
<div class="container">
  <div class="row">
    <div class="col-12">
      <h1>Bodega Buddy Store Menu Availability Search</h1>
    </div>
  </div>
</div>


<div class="container">
  <div class="row">
    <div class="col-12">
      <div id="custom-search-input" style="padding-left: 15px;">
        <div class="input-group custom-search-form" style="width:100%;">
          <input type="text" class="form-control" placeholder="search by keyword">
        </div><!-- /input-group -->
      </div>
    </div>
  </div>
</div>

<div class="container">

  <hgroup class="mb20">
    <h1>Search Results</h1>
    <h2 class="lead"><strong class="text-danger" id="result-count">0</strong> results were found for the search for <strong class="text-danger" id="search-query">_____</strong></h2>
  </hgroup>

  <section class="col-md-12" id="search-results-placholder"></section>
</div>

</html>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

<script>


  function autocomplete() {
    $(':input').keyup(function() {
      var letters = $(this).val();

      $.ajax({
          url: `/search?query=${letters}&path=title`
        }).done(function(results){
          var jsonResults = JSON.parse(results).docs
          console.log(jsonResults)
          render(letters, jsonResults)
        })
        .fail(function(err) {
          console.log(err)
        });

    });
  }

  function highlight(highlights_arr){
    let txt = ``;

    highlights_arr.texts.forEach(function(item) {
      if (item.type == 'hit'){
        txt += `<b><span class="highlight"> ${item.value} </span></b>`;
      }
      else {
        txt += item.value;
      }
    });
    return txt
  }


  function render(letters, results) {
    var placholder = $('#search-results-placholder');
    placholder.empty();

    // update count
    $('#result-count').html(results.length)
    // update search query
    $('#search-query').html(letters)

    let html = '';
    $.each(results, function(index, item) {

      let doc = item.document;

      // // skip items without poster
      // if (doc.poster == undefined) {
      //   return true;
      // }

      html += `
      <article class="search-result row">
        <div class="col-md-3">
          <div class="thumbnail"><img src="${doc.poster}" alt="Lorem ipsum" /></div>
        </div>
        <div class="col-md-2">
          <ul class="meta-search">
            <li>Released: <span>${doc.year}</span></li>
            <li>Length: <span>${doc.runtime} mins</span></li>
            <li>Rating: <span>${doc.rated}</span></li>
          </ul>
        </div>
        <div class="col-md-7 excerpet">
          <h3>${highlight(item.highlights[0])}</h3>
          <!-- <h3>${doc.title}</h3> -->

          <!-- <p>${highlight(item.highlights[0])}</p> -->
          <p>${doc.fullplot}</p>
          <p>Search score: ${item.score}</p>
        </div>
        <span class="clearfix borda"></span>
      </article>
    `
    });
    // place in html
    placholder.append(html);
  }


  $(document).ready(function() {
    autocomplete();
  });
</script>
